#include <stdio.h>
#include <stdlib.h>
#include <libpq-fe.h>

void check_result(PGresult *res, PGconn *conn) {
    if (PQresultStatus(res) != PGRES_TUPLES_OK) {
        fprintf(stderr, "Query failed: %s\n", PQerrorMessage(conn));
        PQclear(res);
        PQfinish(conn);
        exit(1);
    }
}

int main() {
    const char *conninfo = "dbname=dted_db user=youruser password=yourpassword host=localhost";
    PGconn *conn = PQconnectdb(conninfo);

    if (PQstatus(conn) != CONNECTION_OK) {
        fprintf(stderr, "Connection to database failed: %s\n", PQerrorMessage(conn));
        PQfinish(conn);
        return 1;
    }

    double lon = -122.42, lat = 37.77;
    char query[512];
    snprintf(query, sizeof(query),
             "SELECT ST_Value(rast, ST_SetSRID(ST_Point(%f, %f), 4326)) "
             "FROM dted_table "
             "WHERE ST_Intersects(rast, ST_SetSRID(ST_Point(%f, %f), 4326));",
             lon, lat, lon, lat);

    PGresult *res = PQexec(conn, query);
    check_result(res, conn);

    if (PQntuples(res) > 0) {
        printf("Elevation: %s meters\n", PQgetvalue(res, 0, 0));
    } else {
        printf("No elevation data found at this location.\n");
    }

    PQclear(res);
    PQfinish(conn);
    return 0;
}
